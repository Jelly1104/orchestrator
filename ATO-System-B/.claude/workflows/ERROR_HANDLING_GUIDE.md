# 에러 처리 가이드 v2.0

> **문서 버전**: 2.1.0
> **최종 업데이트**: 2026-01-05

> **물리적 경로**: `.claude/workflows/ERROR_HANDLING_GUIDE.md`

> **상위 문서**: CLAUDE.md

> **대상**: Leader, Orchestrator

---

## 이 문서의 목적

**"장애는 발생한다. 대응 절차가 문서화되어 있어야 한다."**

LLM Role 또는 시스템 장애 발생 시 표준 대응 절차를 정의합니다.

---

## 장애 유형 분류

### LLM 오동작 (AI Malfunction)

| 유형                | 심각도   | 예시                          | 자동 대응        |
| ------------------- | -------- | ----------------------------- | ---------------- |
| 환각(Hallucination) | Medium   | 존재하지 않는 컬럼명 사용     | 재시도 1회       |
| 무한 루프           | High     | 같은 출력 반복, 토큰 소진     | 즉시 중단        |
| 권한 위반           | Critical | 하위 Role이 Leader 권한 행사  | 중단 + 알림      |
| 역방향 흐름         | High     | Code→SDD 역생성 시도          | 중단 + 로깅      |
| 재시도 초과         | High     | 3회 재시도 후에도 Review FAIL | 사용자 개입 요청 |

### 데이터 위반 (Data Violation)

| 유형      | 심각도   | 예시                           | 자동 대응             |
| --------- | -------- | ------------------------------ | --------------------- |
| PII 노출  | Critical | 개인정보 평문 출력             | 즉시 중단 + 출력 삭제 |
| 금지 쿼리 | Critical | INSERT/UPDATE/DELETE 실행      | 쿼리 차단 + 알림      |
| Full Scan | High     | 대용량 테이블 인덱스 없이 조회 | 경고 + 쿼리 취소      |

### 보안 위반 (Security Violation)

| 유형           | 심각도   | 예시                                        | 자동 대응          |
| -------------- | -------- | ------------------------------------------- | ------------------ |
| 룰북 수정 시도 | Critical | .claude/{rules, workflows, context}/\* 수정 | 작업 거부 + 로깅   |
| 크레덴셜 노출  | Critical | API 키, 비밀번호 출력                       | 출력 마스킹 + 알림 |
| SQL Injection  | High     | 파라미터 바인딩 없는 쿼리                   | 쿼리 거부          |

---

## 에스컬레이션 경로

### 에스컬레이션 흐름도

```
장애 감지
    │
    ▼
┌──────────┐    Medium     ┌────────┐
│ LLM Role │ ────────────▶ │ Leader │
└──────────┘               └────────┘
    │                            │
    │ High                       │ 해결 불가
    ▼                            ▼
┌────────┐                 ┌─────────────┐
│ Leader │                 │ 운영자(Human)│
└────────┘                 └─────────────┘
    │                            │
    │ Critical                   │
    ▼                            ▼
┌─────────────┐            ┌─────────────┐
│ 운영자(Human)│            │  DBA / 보안팀 │
└─────────────┘            └─────────────┘
```

### 심각도별 대응 주체

| 심각도   | 1차 대응     | 2차 대응   | 알림 방식        |
| -------- | ------------ | ---------- | ---------------- |
| Medium   | Orchestrator | Leader     | 로그 기록        |
| High     | Leader       | 운영자     | 콘솔 경고        |
| Critical | 운영자       | DBA/보안팀 | 즉시 중단 + 알림 |

---

## 즉시 대응 절차

### LLM 오동작 발생 시

**Step 1. 즉시 중단**

- 현재 작업 중단
- 출력 버퍼 클리어

**Step 2. 상태 보고**

- 어떤 오동작이 발생했는지 명시
- 영향 범위 파악

**Step 3. 롤백 여부 판단**

- 파일 변경이 있었는가? → 롤백 필요
- 데이터 변경이 있었는가? → 긴급 에스컬레이션

### 데이터 위반 발생 시

**Step 1. 즉시 중단**

- 쿼리 실행 중단
- 트랜잭션 롤백 (가능한 경우)

**Step 2. 증거 보존**

- 실행된 쿼리 로그 저장
- 영향받은 테이블/행 식별

**Step 3. 에스컬레이션**

- Critical → 운영자 + DBA 즉시 알림
- 복구 계획 수립

### 보안 위반 발생 시

**Step 1. 즉시 중단**

- 모든 작업 중단
- 세션 격리

**Step 2. 증거 보존**

- 전체 대화 로그 저장
- 노출된 정보 식별

**Step 3. 긴급 에스컬레이션**

- 보안팀 즉시 알림
- 크레덴셜 노출 시 → 즉시 키 로테이션

---

## 롤백 절차

### 코드 롤백

Git 명령어를 사용하여 롤백합니다:

- 변경 사항 확인: `git status`, `git diff`
- 커밋 전 취소: `git checkout -- [file]`
- 커밋 후 롤백: `git revert HEAD`

### 문서 롤백

1. 변경된 문서 식별
2. Git 히스토리에서 이전 버전 복원
3. 변경 사유 기록

---

## 포스트모템 템플릿

장애 해결 후 반드시 포스트모템을 작성합니다.

**포스트모템 필수 항목:**

| 섹션           | 내용                                 |
| -------------- | ------------------------------------ |
| 요약           | 발생일시, 해결일시, 심각도, 영향범위 |
| 타임라인       | 시간순 이벤트 기록                   |
| 근본 원인      | Root Cause 분석                      |
| 대응 내역      | 수행한 조치                          |
| 재발 방지 대책 | 체크리스트 형태                      |
| 교훈           | Lessons Learned                      |

---

## Orchestrator 장애 대응

### 실패 유형별 대응

| 유형            | 상태             | 원인                     | 대응               |
| --------------- | ---------------- | ------------------------ | ------------------ |
| API 키 오류     | 시작 불가        | ANTHROPIC_API_KEY 미설정 | .env 파일 확인     |
| Planning 실패   | Phase 1 중단     | PRD 불명확, 토큰 초과    | PRD 수정 후 재시도 |
| Coding 실패     | Phase 2 중단     | HANDOFF 불완전           | Leader에게 재요청  |
| Review 3회 FAIL | 사용자 개입 필요 | 품질 기준 미달           | 수동 수정 필요     |

### USER_INTERVENTION_REQUIRED 대응

**Step 1. 로그 확인**

- 위치: `orchestrator/logs/<task-id>.json`
- 각 Review의 FAIL 사유 분석

**Step 2. 원인 분류**

- Schema 위반 → DOMAIN_SCHEMA.md (.claude/rules/) 확인
- 구조 문제 → SDD 수정 필요 (docs/task-id/SDD.md)
- 테스트 누락 → TDD_WORKFLOW.md (.claude/rules/) 참조

**Step 3. 수동 수정**

- 생성된 파일 수동 편집
- 또는 PRD/SDD 수정 후 Orchestrator 재실행

### 토큰 소진 대응

**작업 분할**

- 큰 작업을 여러 개의 작은 작업으로 분리
- 각 작업별 별도 task-id 부여

**컨텍스트 최적화**

- PRD에서 불필요한 내용 제거
- 핵심 요구사항만 명시

**모델 변경**

- ANTHROPIC_MODEL 환경 변수로 경량 모델 사용

---

## 관련 문서

| 문서                 | 물리적 경로                            | 역할                  |
| -------------------- | -------------------------------------- | --------------------- |
| CLAUDE.md            | .claude/CLAUDE.md                      | 팀 헌법, Safety Rules |
| VALIDATION_GUIDE.md  | .claude/rules/VALIDATION_GUIDE.md      | 품질 검증 기준        |
| ROLE_ARCHITECTURE.md | .claude/workflows/ROLE_ARCHITECTURE.md | Role 권한 및 구조     |

---

**END OF ERROR_HANDLING_GUIDE.md**

_장애 대응은 속도보다 정확성이 중요합니다. 당황하지 말고 절차를 따르세요._
