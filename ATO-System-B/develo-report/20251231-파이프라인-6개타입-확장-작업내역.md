# Pipeline Refactoring 작업 내역 (DD-2025-003)

> **작성일**: 2025-12-31
> **상태**: In Progress
> **목적**: 파이프라인 타입 4개 → 6개 확장 및 HITL 아키텍처 변경

---

## 1. 작업 배경

### 1.1 파이프라인 타입 변경

| 기존 (4개) | 신규 (6개) | 설명 |
|-----------|-----------|------|
| analysis | analysis | A만 (유지) |
| design | design | B만 (유지) |
| mixed | analyzed_design | A → B (이름 변경) |
| - | code | C만 (신규) |
| - | ui_mockup | B → C (신규) |
| - | full | A → B → C (신규) |

### 1.2 HITL 아키텍처 변경

**AS-IS**: 고정 체크포인트 방식
```
Phase A 완료 → [HITL: 분석 결과 승인] → Phase B
Phase B 완료 → [HITL: 설계 승인] → Phase C
Phase C 완료 → [HITL: 배포 승인] → Deploy
```

**TO-BE**: 검증 실패 시에만 HITL
```
Phase 완료 → ImpLeader 자동 검증 → {Objective Rules Pass?}
  ├─ YES → DocSync → 다음 Phase 또는 완료
  └─ NO  → HITL Review → 3-way 옵션
              ├─ Exception Approval (이번만 예외)
              ├─ Rule Override (규칙 수정)
              └─ Reject → 해당 Phase 재작업
```

---

## 2. 완료된 작업

### 2.1 LLM용 문서 수정

| 파일 | 버전 | 수정 내용 |
|------|------|----------|
| ROLE_ARCHITECTURE.md | v3.2.0 | 6개 파이프라인 타입, 현재/목표 테이블 분리, SDD 제약 추가 |
| ROLES_DEFINITION.md | v1.4.0 | 6개 router 값, Coder PRD 참조 금지, SDD↔Code 정합성 |
| PRD_GUIDE.md | v2.2.0 | 6개 키워드/파이프라인 섹션 (3.1~3.6) |
| DOCUMENT_PIPELINE.md | v1.4.0 | 6개 타입별 흐름 상세 |

### 2.2 인간용 문서 수정

| 파일 | 섹션 | 수정 내용 |
|------|------|----------|
| README.md | 1-2 Role-Based Collaboration Model | HITL 플로우 다이어그램 |
| README.md | 2-1 Phase 기반 파이프라인 흐름 | 6개 분기, HITL 3-way 옵션 |
| README.md | 3-2 Orchestrator vs Leader 역할 구분 | 6개 router 값 테이블 |

### 2.3 계획 문서

| 파일 | 버전 | 추가 내용 |
|------|------|----------|
| 20251230-파이프라인재정의계획.md | v5.6.0 | 섹션 8 HITL AS-IS vs TO-BE |

---

## 3. 남은 작업

### 3.1 문서 수정

- [ ] README.md: 섹션 5-2 PRD 파이프라인 라우팅 다이어그램 6개 분기
- [ ] README.md: 섹션 5-3 문서 파이프라인 플로우 재작성
- [ ] ROLE_ARCHITECTURE.md: 섹션 4 HITL 체크포인트 재정의
- [ ] DOCUMENT_PIPELINE.md: HITL 설명 TO-BE로 변경

### 3.2 코드 수정

- [ ] orchestrator.js: runAnalyzedDesignPipeline 수정 (A→B로 종료)
- [ ] orchestrator.js: runFullPipeline 추가 (A→B→C)
- [ ] orchestrator.js: runCodePipeline 추가 (C만)
- [ ] orchestrator.js: runUiMockupPipeline 추가 (B→C)
- [ ] orchestrator.js: 라우터에 6개 케이스 추가
- [ ] orchestrator.js: HITL 3-way 핸들링 로직 추가
- [ ] prd-analyzer.js: 6개 타입 판별 로직 추가
- [ ] leader.js: VALID_ROUTES 6개로 확장
- [ ] leader.js: 검증 결과 기반 라우팅 로직
- [ ] reviewer/index.js: hitlRequired 플래그 반환 로직

---

## 4. 주요 변경 사항 상세

### 4.1 SDD 기반 코드 구현 제약

**Phase C 설명 변경**:
- 기존: "HANDOFF 기반 코드 구현"
- 변경: "**SDD 기반 코드 구현 (PRD 직접 참조 금지)**"

**code 타입 제약**:
- "**SDD/HANDOFF가 이미 존재하는 경우에 한해 구현만 수행**"
- 가드: `if (!exists(SDD.md)) → HITL: Design Skip Approval`

**Coder 입출력 제약**:
```
| **제약** | PRD.md 직접 참조 금지 | Coder는 SDD/HANDOFF만 참조해야 함 |
```

**ImpLeader 검증 항목**:
```
| 구현 코드 | C | **SDD ↔ Code 정합성**, 보안, 로직 정확성, 테스트 |
```

### 4.2 현재 구현 상태

| 타입 | Phase 조합 | 상태 |
|------|-----------|------|
| analysis | A만 | ✅ 구현됨 |
| design | B만 | ✅ 구현됨 |
| mixed | A → B | ✅ 구현됨 |
| code | C만 | 🚧 미구현 |
| analyzed_design | A → B | 🚧 미구현 (mixed로 대체) |
| ui_mockup | B → C | 🚧 미구현 |
| full | A → B → C | 🚧 미구현 |

### 4.3 문서 참조 스타일 변경

**기존** (금지됨):
```
ROLES_DEFINITION(§2)
섹션 7
```

**변경** (권장됨):
```
Leader (PM & Commander)
PRD 파이프라인 라우팅 섹션
```

---

## 5. 파일별 변경 내역

### 5.1 ROLE_ARCHITECTURE.md

```markdown
### 파이프라인 타입 (현재 구현)

| 타입            | Phase 조합 | 상태                        |
| --------------- | ---------- | --------------------------- |
| `analysis`      | A만        | ✅ 구현됨                   |
| `design`        | B만        | ✅ 구현됨                   |
| `mixed`         | A → B      | ✅ 구현됨                   |
| `code`          | C만        | 🚧 미구현                   |
| `analyzed_design` | A → B    | 🚧 미구현 (mixed로 대체)    |
| `ui_mockup`     | B → C      | 🚧 미구현                   |
| `full`          | A → B → C  | 🚧 미구현                   |

### 파이프라인 타입 (목표)

| Type            | Phase 조합 | 설명                                                    | 사용 케이스             |
| --------------- | ---------- | ------------------------------------------------------- | ----------------------- |
| analysis        | A만        | 데이터 분석만                                           | SQL 분석, 리포트        |
| design          | B만        | 설계만                                                  | IA/Wireframe/SDD 작성   |
| code            | C만        | **SDD/HANDOFF가 이미 존재하는 경우에 한해 구현만 수행** | 이미 설계 있고 코딩만   |
| analyzed_design | A → B      | 분석 후 설계                                            | 데이터 기반 UX 설계     |
| ui_mockup       | B → C      | 설계 후 화면 구현                                       | IA/WF 기반 UI 코드 생성 |
| full            | A → B → C  | 전체 파이프라인                                         | 처음부터 끝까지         |

### 스위칭 예시

| Leader 출력                     | 실행 Phase              |
| ------------------------------- | ----------------------- |
| `{ router: "analysis" }`        | A만                     |
| `{ router: "design" }`          | B만                     |
| `{ router: "code" }`            | **C만 (SDD 존재 필수)** |
| `{ router: "analyzed_design" }` | A → B                   |
| `{ router: "ui_mockup" }`       | B → C                   |
| `{ router: "full" }`            | A → B → C               |

> **💡 code 타입 가드**: 실제 구현에서는 `if (!exists(SDD.md)) → HITL: Design Skip Approval` 체크 필요
```

### 5.2 ROLES_DEFINITION.md

```markdown
### 2.1 역할 개요

| **출력**   | `{ router: "analysis" | "design" | "code" | "analyzed_design" | "ui_mockup" | "full" }` |

### 2.3 입출력 정의

| Output | 파이프라인 타입 | `{ router: "analysis/design/code/analyzed_design/ui_mockup/full" }` |
|        |                 | **단, "code" 선택 시 SDD 존재 필수**                                |

### 5.3 검증 항목

| 구현 코드 | C | **SDD ↔ Code 정합성**, 보안, 로직 정확성, 테스트 |

### 6.3 입출력 정의 (Coder)

| **제약** | PRD.md 직접 참조 금지 | Coder는 SDD/HANDOFF만 참조해야 함 |

### 7.2 스위칭 예시

| Leader 출력               | 실행 Phase    | 설명                    |
| ------------------------- | ------------- | ----------------------- |
| `{ router: "analysis" }`  | A만           | 데이터 분석만           |
| `{ router: "design" }`    | B만           | 설계만                  |
| `{ router: "code" }`      | C만           | 구현만                  |
| `{ router: "analyzed_design" }` | A → B   | 분석 후 설계            |
| `{ router: "ui_mockup" }` | B → C         | 설계 후 화면 구현       |
| `{ router: "full" }`      | A → B → C     | 전체 파이프라인         |
```

### 5.3 README.md 섹션 3-2

```markdown
│  4. Router 값 (6개 타입)                                                     │
│     ┌──────────────────┬───────────────┬────────────────────────────────┐   │
│     │ router           │ Phase 조합     │ 설명                           │   │
│     ├──────────────────┼───────────────┼────────────────────────────────┤   │
│     │ "analysis"       │ A만           │ SQL 분석, 리포트                │   │
│     │ "design"         │ B만           │ IA/Wireframe/SDD               │   │
│     │ "code"           │ C만           │ HANDOFF 기반 구현만            │   │
│     │ "analyzed_design"│ A → B         │ 분석 후 설계                   │   │
│     │ "ui_mockup"      │ B → C         │ 설계 후 화면 구현              │   │
│     │ "full"           │ A → B → C     │ 전체 파이프라인                │   │
│     └──────────────────┴───────────────┴────────────────────────────────┘   │
```

---

## 6. 테스트 체크리스트

### 6.1 파이프라인 실행 테스트

- [ ] analysis 파이프라인: Phase A만 실행되는지
- [ ] design 파이프라인: Phase B만 실행되는지
- [ ] code 파이프라인: Phase C만 실행되는지
- [ ] analyzed_design 파이프라인: Phase A → B에서 종료되는지
- [ ] ui_mockup 파이프라인: Phase B → C 실행되는지
- [ ] full 파이프라인: Phase A → B → C 실행되는지

### 6.2 HITL 테스트

- [ ] ImpLeader 자동 검증 PASS → HITL 없이 진행
- [ ] ImpLeader 자동 검증 FAIL → HITL Review 진입
- [ ] Exception Approval → 해당 실행만 예외 통과
- [ ] Rule Override → 규칙 수정 후 진행
- [ ] Reject → 해당 Phase 재작업

### 6.3 예외 케이스 테스트

- [ ] Case 01: 빈 PRD → Gap Check FAIL
- [ ] Case 02: 필수 섹션 누락 → Gap Check 경고
- [ ] Case 03: 잘못된 파이프라인 타입 → FAIL
- [ ] Case 05: 초대형 PRD → 토큰 제한 경고

---

## 7. 관련 문서

| 문서 | 경로 | 역할 |
|------|------|------|
| 계획 문서 | docs/reports/20251230-파이프라인재정의계획.md | 전체 계획 및 체크리스트 |
| ROLE_ARCHITECTURE.md | .claude/workflows/ | 시스템 지도 (Orchestrator용) |
| ROLES_DEFINITION.md | .claude/workflows/ | Role별 매뉴얼 (LLM용) |
| PRD_GUIDE.md | .claude/workflows/ | PRD 작성 가이드 |
| DOCUMENT_PIPELINE.md | .claude/workflows/ | 문서 생성 파이프라인 |
| README.md | .claude/ | 인간용 시각적 가이드 |

---

**END OF DOCUMENT**
