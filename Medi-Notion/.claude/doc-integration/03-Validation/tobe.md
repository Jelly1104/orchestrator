# 검증 통합 가이드 v2.0

> **문서 버전**: 2.0.0
> **최종 업데이트**: 2025-12-18
> **관리자**: 미래전략실 (ATO Team)
> **통합 대상**: OUTPUT_VALIDATION.md, PRD_GAP_CHECK.md, QUALITY_GATES.md

<!--
[통합 배경]
3개 검증 문서가 분리되어 있고, Leader만 QUALITY_GATES를 로딩.
OUTPUT_VALIDATION과 PRD_GAP_CHECK는 어떤 Agent도 로딩하지 않음.
단일 문서로 통합하여 OutputValidator가 모든 검증 기준을 참조하도록 개선.
-->

---

## 📋 Agent 로딩 설정

<!-- [추가] OutputValidator와 Leader가 이 문서를 로딩하도록 명시 -->

| Agent | 로딩 문서 |
|-------|----------|
| **OutputValidator** | `.claude/global/VALIDATION_GUIDE.md` (이 문서) |
| **Leader (Review Mode)** | `.claude/global/VALIDATION_GUIDE.md` (이 문서) |

---

## 1. 검증 파이프라인 개요

<!-- [통합] 기존 3개 문서의 파이프라인을 하나로 -->

```
PRD 입력
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 1: PRD Gap Check (기획 단계)                               │
│   - 필수 항목 체크 (목적, 타겟, 기능, 지표)                         │
│   - 레퍼런스 매칭                                                │
│   - 간극 질문 생성 → 사용자 확인                                  │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 2: Native/Sub Agent 개발                                   │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 3: Output Validation (검토 단계)                           │
│   - Step 1: Syntax/Lint 검증                                    │
│   - Step 2: PRD 체크리스트 매칭                                   │
│   - Step 3: 스키마 정합성 검증                                    │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 4: Quality Gates (배포 전 최종 검증)                        │
│   - 코드 품질, 테스트, 보안, 성능                                  │
│   - 실패 시 재작업 요청                                          │
└─────────────────────────────────────────────────────────────────┘
    ↓
완료
```

---

## 2. Phase 1: PRD Gap Check

<!-- [기존 유지] PRD_GAP_CHECK.md 핵심 내용 -->

### 2.1 필수 항목 체크

```
필수 4개:
- [ ] 목적 (Objective): 왜 만드는가?
- [ ] 타겟 유저 (Target User): 누가 쓰는가?
- [ ] 핵심 기능 (Core Features): 무엇을 하는가?
- [ ] 성공 지표 (Success Criteria): 어떻게 판단하는가?
```

**누락 시 질문**:
```
"PRD에서 [항목명]이 명확하지 않습니다.
예시) [예시 제공]
어떻게 정의하면 될까요?"
```

---

### 2.2 레퍼런스 매칭

```
PRD 키워드 추출
    ↓
유사 카테고리/서비스 매칭
    ↓
패턴 제안

[결과 포맷]
PRD 유형: {카테고리} > {서브 유형}
유사 서비스: {레퍼런스 서비스명}
예상 패턴: {핵심 패턴}

이 방향이 맞을까요? [Y/N/R]
```

---

### 2.3 간극 질문 생성

**산출물 관련**:
```
[체크리스트 있으면]
"체크리스트에 {N}개 항목이 있습니다:
 각 항목을 다음과 같이 처리하려고 합니다:
 - {항목1} → SQL 쿼리로 구현
 - {항목2} → 분석 리포트로 출력
 이 매핑이 맞을까요?"

[없으면]
"산출물 체크리스트가 없습니다.
 PRD 내용 기반으로 다음 산출물을 예상했습니다:
 1. {예상 산출물1}
 맞을까요?"
```

**데이터 관련**:
```
"다음 테이블/컬럼을 사용할 예정입니다:
 - USERS (U_ID, U_KIND, U_ALIVE)
 - USER_DETAIL (U_MAJOR_CODE_1, U_WORK_TYPE_1)

 DOMAIN_SCHEMA.md와 일치하는지 확인했습니다. 진행해도 될까요?"
```

---

### 2.4 사용자 확인 포맷

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 PRD Gap Check 결과
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 필수 항목: 4/4 충족
🔗 레퍼런스 매칭: Amplitude Segmentation
📦 산출물 매핑: 6개
📊 데이터 소스: USERS, USER_DETAIL, CODE_MASTER

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[Y] 진행  [N] 취소  [E] 수정
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 3. Phase 3: Output Validation

<!-- [기존 유지] OUTPUT_VALIDATION.md 핵심 내용 -->

### 3.1 Step 1: Syntax/Lint 검증

| 대상 | 검증 항목 | 심각도 |
|------|----------|--------|
| SQL | INSERT/UPDATE/DELETE 금지 | 🚨 ERROR |
| SQL | DROP/TRUNCATE/ALTER 금지 | 🚨 ERROR |
| SQL | SELECT * 사용 | ⚠️ WARNING |
| SQL | 세미콜론 누락 | ⚠️ WARNING |
| SQL | 대용량 테이블 LIMIT 없음 | ⚠️ WARNING |
| Markdown | 내용 비어있음 | 🚨 ERROR |
| Markdown | 제목(#) 없음 | ⚠️ WARNING |

---

### 3.2 Step 2: PRD 체크리스트 매칭 (3단계 알고리즘)

<!-- [핵심] 기존 하드코딩 → 문서 기반 동적 로딩 -->

```
┌─────────────────────────────────────────────────────┐
│ 1단계: 파일명 직접 매칭 (fuzzy)                        │
│    └─ 파일명과 PRD 항목 유사도 비교                     │
├─────────────────────────────────────────────────────┤
│ 2단계: 콘텐츠 키워드 매칭 (도메인 특화)                  │
│    └─ 도메인 키워드 맵 활용 (섹션 5 참조)               │
├─────────────────────────────────────────────────────┤
│ 3단계: SQL 블록 개별 매칭                              │
│    └─ 파일 내 개별 SQL 쿼리 블록 추출                   │
│    └─ 각 블록별 키워드 매칭 수행                        │
└─────────────────────────────────────────────────────┘

⚡ 매칭률 ≥ 50% → MATCHED
```

---

### 3.3 Step 3: 스키마 정합성 검증

```
SQL 쿼리 파싱
    ↓
테이블/컬럼 추출
    ↓
DOMAIN_SCHEMA.md 대조
    ↓
결과:
  - 알 수 없는 테이블: WARNING
  - 알 수 없는 컬럼: ERROR
  - 금지된 JOIN 패턴: WARNING
  - 대용량 테이블 접근: WARNING
```

---

### 3.4 검증 결과 포맷

**성공 시**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 Output Validation 결과
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

상태: ✅ PASSED
산출물: 6개
  - Syntax 통과: 6/6
  - Schema 유효: 4/4
  - PRD 매칭: 6/6

📋 PRD 체크리스트 매핑:
  1. ✅ 활성 회원 세그먼트 정의 SQL → 활성 회원 세그먼트 SQL
  2. ✅ 프로필-행동 조인 분석 쿼리 → 프로필-행동 조인 쿼리
  ...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**실패 시**:
```
상태: ❌ FAILED

❌ 오류:
  1. [SYNTAX] DELETE 문 사용 금지
  2. [PRD_MISMATCH] PRD 체크리스트 항목 누락: "활성 회원 세그먼트 정의 SQL"
```

---

## 4. Phase 4: Quality Gates

<!-- [기존 유지] QUALITY_GATES.md 핵심 내용 -->

### 4.1 코드 품질 (Code Quality)

**Schema Compliance**:
- [ ] `DOMAIN_SCHEMA.md`의 **실제 레거시 컬럼명** 사용
  - ❌ `user.id`, `user.active`
  - ✅ `user.U_ID`, `user.U_ALIVE`
- [ ] Hallucination Check: 존재하지 않는 테이블/컬럼 추측 금지

**구조 및 네이밍**:
- [ ] 함수 길이 ≤ 30줄
- [ ] 중첩 깊이 ≤ 3단계
- [ ] TypeScript `any` 타입 금지

---

### 4.2 테스트 (Testing)

- [ ] 커버리지 ≥ 90%
- [ ] 모든 테스트 PASS
- [ ] 테스트 독립성 (순서 의존성 없음)
- [ ] Mocking 적절성 (실제 DB 미사용)

---

### 4.3 보안 (Security)

**의료 데이터 특화**:
- [ ] PHI(환자정보) 보호: 주민번호, 진료내역 평문 노출 금지
- [ ] 로그 마스킹: 이메일, 전화번호, 면허번호 로그 금지

**레거시 DB 보호**:
- [ ] Full Scan 방지: `COMMENT`, `USER_LOGIN` 조회 시 인덱스/페이징 필수
- [ ] SQL Injection: 파라미터 바인딩 사용

---

### 4.4 성능 (Performance)

| 유형 | 목표 | 최대 허용 |
|------|------|----------|
| 단순 조회 | < 100ms | 200ms |
| 복합 조회 | < 200ms | 500ms |
| 대용량 조회 | < 500ms | 1,000ms |

- [ ] N+1 문제 해결
- [ ] `SELECT *` 대신 필요 컬럼만 명시

---

### 4.5 Safety Check

**룰북 불변성**:
- [ ] `.claude/global/` 내 파일 변경 없음
- [ ] `CLAUDE.md` 변경 없음

**서버 데이터 보호**:
- [ ] INSERT 쿼리 없음
- [ ] UPDATE 쿼리 없음
- [ ] DELETE 쿼리 없음

---

### 4.6 자동 재시도 정책

```
Review FAIL 시:
  1차 재시도: 피드백 반영 후 자동 수정
  2차 재시도: 피드백 반영 후 자동 수정
  3차 실패: USER_INTERVENTION_REQUIRED

자동 PASS 기준:
  - Schema 준수율 100%
  - TypeScript 에러 0개
  - 테스트 코드 포함
  - Full Scan 패턴 없음
```

---

## 5. 도메인 키워드 맵

<!--
[핵심 변경]
기존: prd-analyzer.js와 output-validator.js에 분산 하드코딩
TO-BE: 이 문서에서 단일 정의, Agent가 동적 추출
-->

```yaml
# 회원 세그먼트 관련
'활성 회원': ['u_alive', 'active', 'segment', '활성', 'alive']
'세그먼트': ['segment', 'heavy', 'medium', 'light', '세그먼트']

# 전문과목 관련
'전문과목': ['u_major_code', 'major', '분포', '과목', 'specialty']
'진료과': ['u_major_code', 'department', '진료']

# 근무형태 관련
'근무형태': ['u_work_type', 'work_type', '근무', 'employment']
'직장유형': ['u_work_type', '직장', 'workplace']

# 행동 데이터 관련
'로그인': ['user_login', 'login', 'login_date', '접속']
'댓글': ['comment', 'comment_idx', '댓글', '작성']
'게시글': ['board', 'board_idx', '게시', '포스트']

# 분석 관련
'프로필': ['user_detail', 'profile', '프로필', '인적사항']
'조인': ['join', 'inner join', 'left join', '결합']
'분포': ['distribution', 'group by', '분포', '비율']
```

---

## 6. 검증 결과 보고 형식

<!-- [통합] 기존 3개 문서의 보고 형식을 하나로 -->

```markdown
# 검증 결과 종합

## 전체 평가: [PASS / FAIL]

| Phase | 결과 | 핵심 지표 |
|-------|------|---------|
| PRD Gap Check | ✅ PASS | 필수 4/4, 산출물 6개 매핑 |
| Output Validation | ✅ PASS | Syntax 6/6, PRD 매칭 100% |
| Quality Gates | ✅ PASS | Schema 100%, 테스트 93% |

## 발견된 이슈
[없음 또는 이슈 상세]

## 권장 사항
[없음 또는 개선 권고]
```

---

## 7. 관련 문서

| 문서 | 역할 |
|------|------|
| `DOMAIN_SCHEMA.md` | 스키마 정합성 검증 기준 |
| `PRD_GUIDE.md` | PRD 유형/파이프라인 정의 |
| `CLAUDE.md` | 품질 기준 최상위 근거 |

---

**END OF VALIDATION_GUIDE.md**

*품질은 타협의 대상이 아닙니다. 이 게이트를 통과하지 못한 코드는 '미완성'입니다.*

---

## 📝 변경 이력 (TO-BE 주석)

<!--
=== 통합 및 변경 사항 요약 ===

[통합] OUTPUT_VALIDATION.md + PRD_GAP_CHECK.md + QUALITY_GATES.md → 단일 문서
- 이유: 3개 검증 문서가 분리되어 검증 흐름 단절, 중복 내용 존재
- 효과: OutputValidator가 단일 문서만 로딩하면 전체 검증 기준 확보

[추가] "📋 Agent 로딩 설정" 섹션
- 이유: OutputValidator와 Leader가 어떤 문서를 로딩해야 하는지 명시 필요
- 효과: 문서-Agent 매핑 명확화

[추가] "검증 파이프라인 개요" 섹션 (섹션 1)
- 이유: Phase 1~4의 전체 흐름을 한눈에 파악 필요
- 효과: Gap Check → Output Validation → Quality Gates 연동 명확화

[핵심 변경] 도메인 키워드 맵 단일화 (섹션 5)
- 기존: prd-analyzer.js와 output-validator.js에 분산 하드코딩
- TO-BE: 이 문서에서 단일 정의
- 효과: 키워드 추가/수정이 문서 편집만으로 가능, 중복 제거

[통합] 검증 결과 보고 형식 (섹션 6)
- 기존: 3개 문서에 각각 다른 보고 형식 존재
- TO-BE: 단일 종합 보고 형식
- 효과: 일관된 검증 결과 출력

[삭제 대상] 기존 3개 분리 문서
- OUTPUT_VALIDATION.md → 이 문서로 통합
- PRD_GAP_CHECK.md → 이 문서로 통합
- QUALITY_GATES.md → 이 문서로 통합
- 삭제 시점: 이 문서 적용 후 검증 완료 시
-->
