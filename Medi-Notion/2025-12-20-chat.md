# 2025-12-20 Chat Log: System B 구현 (Gemini 조언 기반)

## 개요

이 대화에서는 Gemini의 조언을 바탕으로 System A(CLI 기반)에서 System B(Viewer/HITL 기반)로의 전환을 위한 구현 계획을 수립하고 실행했습니다.

---

## 1. Gemini 조언 요약

### Red Team Review 3가지 주의사항

1. **파일 경로 의존성**: `.claude/global/`에서 새 폴더로 이동 시 100개 이상의 경로 참조가 깨질 수 있음
2. **waitForApproval 구현 방식**: Polling 방식 권장, 프로세스 재시작 시에도 복구 가능해야 함
3. **SYSTEM_MANIFEST.md는 AI용**: 단순 목차가 아닌 AI 페르소나와 행동 강령 포함 필요

### Gemini의 문서 그룹화 전략

| 그룹 | 용도 | 문서 |
|------|------|------|
| **Group A: Rules** | 지식 베이스 | CODE_STYLE.md, TDD_WORKFLOW.md, DOMAIN_SCHEMA.md 등 |
| **Group B: Workflows** | 프로세스 | DOCUMENT_PIPELINE.md, AGENT_ARCHITECTURE.md 등 |
| **Group C: Context** | 컨텍스트 | CLAUDE.md, AI_Playbook.md 등 |

---

## 2. 수정된 전략: 논리적 그룹화

물리적 폴더 이동 대신 `SYSTEM_MANIFEST.md`에서 **논리적 그룹화**를 정의하는 방식으로 변경.

이유: `.claude/global/` 경로 참조가 100개 이상 존재하여 물리적 이동 시 리스크가 높음.

---

## 3. 구현 완료 항목

### Phase 1: SYSTEM_MANIFEST.md 생성

**파일**: `.claude/global/SYSTEM_MANIFEST.md`

주요 내용:
- System B 정체성 정의 ("너는 System B의 Orchestrator다")
- 문서 논리적 그룹화 (Group A/B/C)
- HITL 5개 체크포인트 정의
- Orchestrator 행동 규칙 및 금지 사항
- Viewer 연동 API 문서화

### Phase 2: HITL 트리거 삽입

**파일**: `orchestrator/orchestrator.js`

삽입된 체크포인트:

```javascript
// 1. PRD_REVIEW (PRD Gap Check 불완전 시)
if (prdClassification?.gapCheck?.missing?.length > 0) {
  const prdCheckpoint = this.checkHITLRequired('planning', { gapCheck });
  if (prdCheckpoint) {
    await this.pauseForHITL(taskId, prdCheckpoint, context);
    const approval = await this.waitForApproval(taskId);
    // 승인/거부 처리
  }
}

// 2. DESIGN_APPROVAL (설계 완료 후)
const designCheckpoint = this.checkHITLRequired('design', { requiresApproval: true });
if (designCheckpoint) {
  await this.pauseForHITL(taskId, designCheckpoint, context);
  const designApproval = await this.waitForApproval(taskId);
  // 승인/거부 처리
}

// 3. MANUAL_FIX (3회 연속 FAIL 시)
const manualFixCheckpoint = this.checkHITLRequired('review_fail', { retryCount });
if (manualFixCheckpoint) {
  await this.pauseForHITL(taskId, manualFixCheckpoint, context);
  const manualApproval = await this.waitForApproval(taskId);
  // 승인/거부 처리
}
```

### Phase 3: WebSocket 양방향 연동

**파일**: `orchestrator/viewer/server.js`

추가된 기능:
- `.hitl/` 디렉토리 실시간 감시 (chokidar)
- HITL 파일 생성 시 → `hitl_pending` WebSocket 브로드캐스트
- HITL 파일 삭제 시 → `hitl_resolved` WebSocket 브로드캐스트

```javascript
const hitlWatcher = chokidar.watch(hitlDir, {
  persistent: true,
  ignoreInitial: true,
  awaitWriteFinish: { stabilityThreshold: 300, pollInterval: 100 }
});

hitlWatcher.on('add', (filePath) => {
  // hitl_pending 브로드캐스트
});

hitlWatcher.on('unlink', (filePath) => {
  // hitl_resolved 브로드캐스트
});
```

---

## 4. 파일 변경 요약

| 파일 | 변경 유형 | 버전 |
|------|----------|------|
| `.claude/global/SYSTEM_MANIFEST.md` | 신규 생성 | 1.0.0 |
| `orchestrator/orchestrator.js` | HITL 트리거 삽입 | 3.4.0 |
| `orchestrator/viewer/server.js` | HITL 감시 추가 | 1.6.0 |

---

## 5. System B 현재 상태

```
┌─────────────────────────────────────────────────────────────┐
│  System B 구현 현황                                          │
├─────────────────────────────────────────────────────────────┤
│  ✅ Session Store (pause/resume)                            │
│  ✅ HITL 5개 체크포인트 정의                                  │
│  ✅ HITL 트리거 실제 삽입 (orchestrator.js)                   │
│  ✅ Viewer HITL UI                                          │
│  ✅ WebSocket 양방향 연동 (.hitl/ 감시)                       │
│  ✅ SYSTEM_MANIFEST.md (AI 컨트롤 타워)                       │
│                                                             │
│  📌 남은 작업: Phase 4 통합 테스트                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. HITL 체크포인트 요약

| # | 체크포인트 | 트리거 조건 | 사람의 액션 |
|---|------------|-------------|-------------|
| 1 | PRD_REVIEW | PRD Gap Check 불완전 | PRD 보완 후 재시작 |
| 2 | QUERY_REVIEW | SQL 결과 이상 | 쿼리 수정 또는 승인 |
| 3 | DESIGN_APPROVAL | IA/Wireframe/SDD 생성 완료 | 설계 검토 및 승인 |
| 4 | MANUAL_FIX | 3회 연속 Review FAIL | 직접 수정 또는 방향 조정 |
| 5 | DEPLOY_APPROVAL | 프론트엔드 배포 필요 시 | 최종 배포 승인 |

---

## 7. 다음 단계

1. **Phase 4: 통합 테스트**
   - Orchestrator 실행 → HITL 체크포인트 도달 → Viewer에서 승인/거부 → 재개 확인

2. **추가 개선 사항**
   - QUERY_REVIEW, DEPLOY_APPROVAL 체크포인트 코드 삽입
   - 프로세스 재시작 시 세션 복구 로직

---

## 8. 관련 문서

- [SYSTEM_MANIFEST.md](.claude/global/SYSTEM_MANIFEST.md) - AI 컨트롤 타워
- [AGENT_ARCHITECTURE.md](.claude/global/AGENT_ARCHITECTURE.md) - HITL 플로우 다이어그램
- [session-store.js](orchestrator/state/session-store.js) - 세션 상태 관리
- [server.js](orchestrator/viewer/server.js) - Viewer WebSocket 서버

---

*Generated: 2025-12-20*
